<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reading List - Second Brain</title>
    <link rel="stylesheet" href="styles.css?v=solid">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        .shelf {
            padding: 24px;
            border-radius: 12px;
            margin-bottom: 32px;
        }

        .shelf-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid #f0f0f0;
            padding-bottom: 12px;
        }

        .book-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
        }

        .book-card {
            background: #f9f9f9;
            border-radius: 8px;
            padding: 16px;
            position: relative;
            transition: transform 0.2s;
            border: 1px solid #e5e5e5;
        }

        .book-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        .book-cover {
            height: 140px;
            background: #e0e0e0;
            border-radius: 4px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            color: #999;
        }

        .now-reading-limit {
            color: #d97706;
            font-size: 0.85rem;
            background: #fffbeb;
            padding: 4px 8px;
            border-radius: 4px;
        }
    </style>
</head>

<body>
    <div class="page-container" style="animation: fadeIn var(--anim-duration) ease;">
        <div class="page-header card-premium"
            style="padding: 20px; border-radius: 16px; margin-bottom: 24px; background: white !important;">
            <h1 style="margin: 0;">üìö Reading List</h1>
            <div class="flex gap-2">
                <button class="btn btn-primary" onclick="openAddModal()">+ Add Book</button>
                <a href="index.html" class="back-button">‚Üê Dashboard</a>
            </div>
        </div>

        <!-- Shelf 1: Now Reading -->
        <div class="shelf card-premium">
            <div class="shelf-header">
                <div class="flex items-center gap-3">
                    <h2>üìò Now Reading</h2>
                    <span class="now-reading-limit">Limit: 1-2 Max</span>
                </div>
                <span class="badge badge-blue">Focus</span>
            </div>
            <div id="shelf-Now" class="book-grid"></div>
        </div>

        <!-- Shelf 2: Next Up -->
        <div class="shelf card-premium">
            <div class="shelf-header">
                <h2>üìï Next Up</h2>
                <span class="badge badge-yellow">Queue</span>
            </div>
            <div id="shelf-Next" class="book-grid"></div>
        </div>

        <!-- Shelf 3: Someday -->
        <div class="shelf card-premium">
            <div class="shelf-header">
                <h2>üìó Someday</h2>
                <span class="badge badge-green">Library</span>
            </div>
            <div id="shelf-Someday" class="book-grid"></div>
        </div>
    </div>

    <!-- Modal -->
    <div class="modal-overlay" id="bookModal">
        <div class="modal card-premium" style="background: white !important;">
            <div class="modal-header">
                <h2 class="modal-title">Add Book</h2>
                <button class="modal-close" onclick="closeModal()">√ó</button>
            </div>
            <form id="bookForm">
                <div class="form-group">
                    <label class="form-label">Title</label>
                    <input type="text" name="title" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Shelf</label>
                    <select name="status" class="form-select" required onchange="checkLimit(this)">
                        <option value="Now">üìò Now Reading</option>
                        <option value="Next">üìï Next Up</option>
                        <option value="Someday">üìó Someday</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Category</label>
                    <select name="category" class="form-select" required>
                        <option value="Skill">Skill / Career</option>
                        <option value="Money">Money / Psychology</option>
                        <option value="Philosophy">Philosophy / Calm</option>
                        <option value="Fiction">Fiction</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Notes</label>
                    <textarea name="notes" class="form-input" rows="3"></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Shelve It</button>
                </div>
            </form>
        </div>
    </div>

    <script src="data-manager.js"></script>
    <script src="app.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            setupForm();
            renderBooks();

            // Real-time synchronization!
            dataManager.onUpdate((db) => {
                if (!db || db === 'reading' || db === 'books') renderBooks();
            });
        });

        function setupForm() {
            const form = document.getElementById('bookForm');
            form.addEventListener('submit', (e) => {
                e.preventDefault();
                const formData = new FormData(form);
                const data = Object.fromEntries(formData.entries());

                if (data.status === 'Now') {
                    const currentNow = dataManager.getData('books').filter(b => b.status === 'Now' && b.id !== form.dataset.editId).length;
                    if (currentNow >= 2) {
                        alert('Rule check: Finish a book before starting a new one! (Max 2 allowed)');
                        return;
                    }
                }

                if (form.dataset.editId) {
                    dataManager.updateItem('books', form.dataset.editId, data);
                } else {
                    dataManager.addItem('books', data);
                }
                closeModal();
            });
        }

        function renderBooks() {
            const books = dataManager.getData('books');
            const shelves = {
                'Now': document.getElementById('shelf-Now'),
                'Next': document.getElementById('shelf-Next'),
                'Someday': document.getElementById('shelf-Someday')
            };

            Object.values(shelves).forEach(el => el.innerHTML = '');

            books.forEach(book => {
                if (shelves[book.status]) {
                    const el = document.createElement('div');
                    el.className = 'book-card';
                    el.innerHTML = `
                        <div class="book-cover">üìñ</div>
                        <h3 style="font-size: 1rem; margin: 0 0 4px 0;">${utils.escapeHtml(book.title)}</h3>
                        <div class="text-xs text-gray mb-2">${book.category}</div>
                        <div class="flex gap-2 mt-3">
                            <button class="btn btn-xs btn-secondary w-full" onclick="editBook('${book.id}')">Edit</button>
                            ${book.status === 'Now' ? `<button class="btn btn-xs btn-success w-full" onclick="finishBook('${book.id}')">Finish</button>` : ''}
                        </div>
                    `;
                    shelves[book.status].appendChild(el);
                }
            });

            Object.keys(shelves).forEach(key => {
                if (shelves[key].children.length === 0) {
                    shelves[key].innerHTML = '<div class="text-gray text-sm italic p-4">Empty shelf</div>';
                }
            });
        }

        async function finishBook(id) {
            if (await confirmDelete('Did you finish this book?')) {
                const book = dataManager.getItemById('books', id);
                book.status = 'Completed'; // Or delete? Let's assume archive
                dataManager.deleteItem('books', id); // For now delete to clear space
                showToast('Great job! Book finished.');
            }
        }

        function checkLimit(select) {
            // Visual only
        }

        function openAddModal() {
            document.getElementById('bookForm').reset();
            delete document.getElementById('bookForm').dataset.editId;
            document.getElementById('bookModal').classList.add('active');
        }

        function editBook(id) {
            const book = dataManager.getItemById('books', id);
            if (!book) return;
            const form = document.getElementById('bookForm');
            form.dataset.editId = id;
            form.elements.title.value = book.title;
            form.elements.status.value = book.status;
            form.elements.category.value = book.category;
            form.elements.notes.value = book.notes || '';
            document.getElementById('bookModal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('bookModal').classList.remove('active');
        }
    </script>
</body>

</html>